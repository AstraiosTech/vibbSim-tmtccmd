.. _cfdp:

====================================
CCSDS File Delivery Protocol (CFDP)
====================================

The `tmtccmd` package offers some high-level CCSDS File Delivery Protocol (CFDP) components to
perform file transfers according to the `CCSDS Blue Book 727.0-B-5`_. The underlying base packet
library used to generate the packets to be sent is the `spacepackets`_ library.
The basic idea of CFDP is to convert files of any size to a stream of packets called packet
data units (PDU). CFPD has an unacknowledged and acknowledged mode, with the option to request
a transaction closure. Using the unacknowledged mode with no transaction closure is applicable
for simplex communication paths, while the unacknowledged mode with closure is the easiest
way to get a confirmation of a successfull file transfer, including a CRC check on the remote
side to verify file integrity. Currently, this library only supports the unacknowledged mode.

The core of these high-level components are the :py:class:`tmtccmd.cfdp.handler.dest.DestHandler`
and the :py:class:`tmtccmd.cfdp.handler.source.SourceHandler` component. These model the CFDP
destination and CFDP source entity respectively.

CFDP source entity
-------------------

The :py:class:`tmtccmd.cfdp.handler.source.SourceHandler` converts a
:py:class:`tmtccmd.cfdp.request.PutRequest` into all packet data units (PDUs) which need to be
sent to a remote CFDP entity to perform a File Copy operation to a remote entity. The source entity
allows freedom of communcation by only generating the packets required to be sent, and leaving the
actual transmission of those packets to the user. The packet is returned to the user using
the :py:class:`spacepackets.cfdp.pdu.helper.PduHolder` field of the
:py:class:`tmtccmd.cfdp.handler.source.FsmResult` structure returned in the
:py:meth:`tmtccmd.cfdp.handler.source.SourceHandler.state_machine` call.

The state machine of the source entity will generally perform the following steps, after
a valid :py:class:`tmtccmd.cfdp.request.PutRequest` to perform a File Copy operation was received:

1. Generate the Metadata PDU to be sent to a remote CFDP entity. The PDU will be returned as a
   :py:class:`spacepackets.cfdp.pdu.metadata.MetadataPdu` instance.
2. Generate all File Data PDUs to be sent to a remote CFDP entity, if applicable (file not empty).
   The PDU(s) will be returned as a :py:class:`spacepackets.cfdp.pdu.file_data.FileDataPdu`
   instance(s).
3. Generate an EOF PDU be sent to a remote CFDP entity.
   The PDU will be returnedf as a :py:class:`spacepackets.cfdp.pdu.eof.EofPdu` instance.

CFDP destination entity
------------------------

The :py:class:`tmtccmd.cfdp.handler.dest.DestHandler` can convert the PDUs sent from a remote
source entity ID back to a file. A file copy operation on the receiver side is started with
the reception of a Metadata PDU, for example one generated by the
:py:class:`spacepackets.cfdp.pdu.metadata.MetadataPdu` class . After that, file packet PDUs, for
example generated by the :py:class:`spacepackets.cfdp.pdu.file_data.FileDataPdu`, can be inserted
into the destination handler and will be assembled into a file. The transaction will be finished
for the following conditions:

1. A valid EOF PDU, for example generated by the :py:class:`spacepackets.cfdp.pdu.eof.EofPdu`
   class, has been inserted into the class.
2. All check timers have elapsed. These check timers allow and out-of-order reception of EOF and
   file data PDUs, provided that the interval between the EOF PDU and the last file data PDUs is
   not too large. Check timer support is not implemented yet.
3. All confirmation packets like Finished PDUs have been sent back and confirmed by the remote side
   where applicable. 

Example application
--------------------

You can find an example application inside the `example directory <https://github.com/robamu-org/tmtccmd/tree/rework-cfdp-api/examples/cfdp>`_
which shows an end-to-end file transfer on a host computer. This should give you a general idea of
how to source and destination handler work.

.. _`CCSDS Blue Book 727.0-B-5`: https://public.ccsds.org/Pubs/727x0b5.pdf
.. _`spacepackets`: https://github.com/us-irs/spacepackets-py
